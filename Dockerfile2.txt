# ============================================================
# NeuralTrade - Production Dockerfile (Optimized)
# ============================================================
# Multi-stage build with TA-Lib, security hardening, and monitoring
# ============================================================

# Build arguments
ARG PYTHON_VERSION=3.11
ARG TA_LIB_VERSION=0.4.0

# Stage 1: Builder with TA-Lib
FROM python:${PYTHON_VERSION}-slim as builder

WORKDIR /build

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    wget \
    libffi-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Build TA-Lib
ARG TA_LIB_VERSION
RUN wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-${TA_LIB_VERSION}-src.tar.gz && \
    tar -xvzf ta-lib-${TA_LIB_VERSION}-src.tar.gz && \
    cd ta-lib/ && \
    ./configure --prefix=/usr && \
    make && \
    make install && \
    cd .. && \
    rm -rf ta-lib ta-lib-${TA_LIB_VERSION}-src.tar.gz

# Copy and install requirements (layer caching optimization)
COPY requirements.txt .
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    pip uninstall -y keras || true && \
    pip install tf-keras
    
    

# Pre-build OpenBB to avoid runtime permission issues
# OpenBB creates .build.lock on first import - do this as root in builder
RUN python3 -c "import sys; sys.path.insert(0, '/usr/local/lib/python3.11/site-packages'); from openbb import obb; print('OpenBB built successfully')" || true

# Fix OpenBB permissions (in case build created files)
RUN chmod -R 755 /usr/local/lib/python3.11/site-packages/openbb 2>/dev/null || true

# Stage 2: Runtime
FROM python:${PYTHON_VERSION}-slim as runtime

WORKDIR /app

# Install runtime dependencies + curl for healthchecks
RUN apt-get update && apt-get install -y --no-install-recommends \
    libgomp1 \
    libmagic1 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy TA-Lib from builder
COPY --from=builder /usr/lib/libta_lib* /usr/lib/
COPY --from=builder /usr/include/ta-lib /usr/include/ta-lib

# Copy Python packages from builder (use wildcard for minor version)
COPY --from=builder /usr/local/lib/python3.11/site-packages /usr/local/lib/python3.11/site-packages

# Copy application code
COPY . .

# Create non-root user with proper permissions
RUN groupadd -r neuraltrade && \
    useradd -r -m -d /home/neuraltrade -s /bin/bash -g neuraltrade neuraltrade && \
    mkdir -p /app/data /app/logs /app/config && \
    mkdir -p /home/neuraltrade/.openbb /tmp/matplotlib /tmp/openbb_cache && \
    mkdir -p /tmp/huggingface/{hub,transformers,sentence-transformers} && \
    chown -R neuraltrade:neuraltrade /app && \
    chown -R neuraltrade:neuraltrade /home/neuraltrade && \
    chown -R neuraltrade:neuraltrade /tmp/huggingface && \
    chmod -R 755 /tmp/matplotlib /tmp/openbb_cache && \
    chown -R neuraltrade:neuraltrade /tmp/matplotlib /tmp/openbb_cache

USER neuraltrade

# Environment variables
ENV PYTHONOPTIMIZE=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTORCH_CUDA_ALLOC_CONF=max_split_size_mb:128 \
    PYTHONHASHSEED=random \
    NEURALTRADE_ENV=production \
    PYTHONPATH=/app \
    HOME=/home/neuraltrade \
    MPLCONFIGDIR=/tmp/matplotlib \
    OPENBB_CACHE_DIR=/tmp/openbb_cache \
    OPENBB_USER_DATA_DIRECTORY=/home/neuraltrade/.openbb \
    TF_CPP_MIN_LOG_LEVEL=3 \
    TF_ENABLE_ONEDNN_OPTS=0 \
    HF_HOME=/app/data/huggingface \
    HF_HUB_CACHE=/tmp/huggingface/hub \
    TRANSFORMERS_CACHE=/tmp/huggingface/transformers \
    SENTENCE_TRANSFORMERS_HOME=/tmp/huggingface/sentence-transformers \
    HF_HUB_DISABLE_TELEMETRY=1 \
    USE_TORCH=1 \
    USE_TF=0 \
    TRANSFORMERS_NO_TF=1 
    

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Expose ports: 8000=API, 50051=gRPC, 9090=Metrics
EXPOSE 8000 50051 9090

# Metadata labels
LABEL org.opencontainers.image.title="NeuralTrade AI Trading Platform" \
      org.opencontainers.image.description="86-module quantitative trading system with ML/AI" \
      org.opencontainers.image.vendor="NeuralTrade" \
      org.opencontainers.image.version="2.0" \
      org.opencontainers.image.created="2026-01-21" \
      maintainer="NeuralTrade Team"

# Run FastAPI server (use uvicorn for production)
CMD ["python", "-m", "uvicorn", "api_server:app", "--host", "0.0.0.0", "--port", "8000"]